<p><% breadcrumb :EventHome %></p>


    <h2 class="mb-4">ã‚¤ãƒ™ãƒ³ãƒˆå…±æœ‰ä¸€è¦§</h2>
  <div class="search_form">
  <%= search_form_for @q do |f| %>
  <div class="up-field">
  <%= f.label :title_cont, "#"%>
    <%= f.search_field :title_cont,placeholder:"ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢" %>  <%= f.submit "ğŸ”" %>
    </div>
    <div class="down-field">
  <%= f.label :description_cont, "#" %>
  <%= f.search_field :description_cont,placeholder:"ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢" %>  <%= f.submit "ğŸ”" %>
</div>
  <br>

<% end %>
  </div>


<div class="container mt-5">

<div class="tag-lists">
  <%= link_to 'ã™ã¹ã¦', events_path, class: "tag #{'active' if params[:tag_id].nil?}" %>
  <% Tag.all.each do |tag| %>
    <%= link_to tag.name, events_path(tag_id: tag.id), class: "tag #{'active' if params[:tag_id].to_i == tag.id}" %>
  <% end %>
</div>

<div class="events-container">
  <div class="d-flex flex-wrap">
    <% @events.each do |event| %>
      <div class="col-md-4 mb-4">
        <div class="card event-item">
                    <p>è¡ŒããŸã„! :<span id="likes-count-<%= event.id %>"><%= event.likes.count %></span></p>

          <% if event.image.attached? %>
            <%= image_tag event.image.variant(resize: "300x200^", gravity: "center", crop: "300x200+0+0"), class: "card-img-top" %>
          <% else %>
            <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 200px;">
              <span class="text-muted">No Image</span>
            </div>
          <% end %>

            <h5 class="card-title"><%= link_to event.title, event_path(event),class:"title_text" %></h5>
          <div class="card-body">            
                <p>ã‚¿ã‚°: <%= event.tag.name %></p>
            <p class="card-text">æ¦‚è¦ï¼š<%= auto_link(truncate(event.description, length: 100), html: { target: '_blank' }) %></p>            
            <p class="card-text">
              <small class="text-muted">
                ä¸»å‚¬è€…: <%= link_to event.user.name, user_path(event.user) %>
              </small>
              </p>

              <p class="card-text">
              <small class="text-muted">
                å ´æ‰€: <%= event.location %>
              </small>
            </p>
            </p>
            <p class="card-text">
              <small class="text-muted">
                é–‹å‚¬æ—¥: <%= event.start_time.strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M") %>
              </small>
            </p>
            
                  <div class="url-preview">
        <input type="text" class="url-input" placeholder="URLã‚’å…¥åŠ›">
        <button class="preview-btn">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
      </div>
      <div class="preview-container"></div>
    
<script>
document.addEventListener('turbo:load', function() {
  document.querySelectorAll('.preview-btn').forEach(button => {
    button.addEventListener('click', function() {
      const urlInput = this.previousElementSibling;
      const url = urlInput.value;
      const previewContainer = this.closest('.event-item').querySelector('.preview-container');

      if (!url) {
        previewContainer.innerHTML = '<p>URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p><button class="close-preview-btn">é–‰ã˜ã‚‹</button>';
        previewContainer.style.display = 'block';
        return;
      }

      fetch(`/preview_description?url=${encodeURIComponent(url)}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            previewContainer.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${data.error}</p><button class="close-preview-btn">é–‰ã˜ã‚‹</button>`;
          } else {
            previewContainer.innerHTML = `<p>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${data.description}</p><button class="close-preview-btn">é–‰ã˜ã‚‹</button>`;
          }
          previewContainer.style.display = 'block';
        })
        .catch(error => {
          console.error('ã‚¨ãƒ©ãƒ¼:', error);
          previewContainer.innerHTML = '<p>èª¬æ˜ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p><button class="close-preview-btn">é–‰ã˜ã‚‹</button>';
          previewContainer.style.display = 'block';
        });
    });
  });

  // ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ã‚’ä½¿ç”¨ã—ã¦é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½ã‚’è¿½åŠ 
  document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('close-preview-btn')) {
      const previewContainer = e.target.closest('.preview-container');
      if (previewContainer) {
        previewContainer.style.display = 'none';
      }
    }
  });
});
</script>
            
          </div>
        </div>
      </div>

      
    <% end %>
  </div>
 </div> 
<%= paginate @events %>
</div>